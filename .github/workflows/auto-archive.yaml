name: ðŸ“¦ Auto-Archive Merged Branches
# This Workflow is used for renaming branches of closed PRs
# to "archived/{branch_name}"
#
# This is so our supervisors can revisit our workflow and grade our work

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  archive-branch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Archive merged branch
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          if [ "$BRANCH_NAME" = "$DEFAULT_BRANCH" ] || [[ "$BRANCH_NAME" == archived/* ]]; then
            echo "â­ï¸ Skipping: Branch is default branch or already archived"
            exit 0
          fi

          if [[ "$PR_TITLE" == *NO_ARCHIVE* ]]; then
            echo "â­ï¸ Skipping: PR title contains NO_ARCHIVE"
            exit 0
          fi

          TAG_NAME="archived/$BRANCH_NAME"

          echo "ðŸ·ï¸ Archiving branch: $BRANCH_NAME -> tag $TAG_NAME"

          git fetch origin "$BRANCH_NAME"
          git tag "$TAG_NAME" "origin/$BRANCH_NAME"
          git push origin "$TAG_NAME"
          git push origin --delete "$BRANCH_NAME"

          echo "âœ… Successfully archived branch as tag $TAG_NAME"