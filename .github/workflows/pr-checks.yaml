name: ðŸ”„ PR Checks

on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read
  checks: write
  pull-requests: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: ðŸ§­ Detect Changed Projects
    runs-on: ubuntu-latest
    outputs:
      proctor: ${{ steps.filter.outputs.proctor }}
      server: ${{ steps.filter.outputs.server }}
      sentinel: ${{ steps.filter.outputs.sentinel }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ðŸ”Ž Filter paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            proctor:
              - 'proctor/**'
            server:
              - 'server/**'
            sentinel:
              - 'sentinel/**'

  build-proctor:
    name: ðŸ—ï¸ Build Proctor
    needs: changes
    if: ${{ needs.changes.outputs.proctor == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          environment: proctor
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: ðŸ§ª Check Proctor
        run: |
          cd proctor
          nix develop .#proctor --command fr-proctor-pr-check

      - name: ðŸ§¾ Report eslint results
        uses: ataylorme/eslint-annotate-action@v3
        if: failure()
        with:
          check-name: ðŸ§¹ Lint & ðŸ§ª Test Results
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          report-json: proctor/eslint_report.json

  build-server:
    name: ðŸ—ï¸ Build Server
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          environment: server
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: ðŸ—„ï¸ Start Docker Compose
        uses: hoverkraft-tech/compose-action@3846bcd61da338e9eaaf83e7ed0234a12b099b72 # v2.4.1
        with:
          compose-file: server/docker/docker-compose.yaml
          services: postgres

      - name: ðŸ§ª Verify Server
        run: |
          cd server
          nix develop .#server --command fr-server-pr-check
      
      - name: ðŸ“¦ Build Server Package
        run: |
          set -euo pipefail
          if ! nix build .#franklyn-server; then
            drv_path=$(nix path-info --derivation .#franklyn-server)
            echo "nix build failed; showing log for ${drv_path}" >&2
            nix log "${drv_path}" || echo "nix log unavailable for ${drv_path}" >&2
            exit 1
          fi

      - name: ðŸ§¾ Report ktlint results
        uses: gmazzo/publish-report-annotations@v1
        if: failure()
        with:
          checkName: ðŸ§¹ Lint & ðŸ§ª Test Results
          token: ${{ secrets.GITHUB_TOKEN }}
          reports: |
            **/ktlint.xml
            **/surefire-reports/*.xml

      - name: ðŸ“¤ Report Coverage
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: true
          flags: server
          token: ${{ secrets.CODECOV_TOKEN }}
          name: codecov-server
          files: server/target/jacoco-report/jacoco.xml
          verbose: true

  build-sentinel:
    name: ðŸ—ï¸ Build Sentinel
    needs: changes
    if: ${{ needs.changes.outputs.sentinel == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          environment: sentinel
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: ðŸ§ª Verify Sentinel
        run: |
          cd sentinel
          nix develop .#sentinel --command fr-sentinel-pr-check

      - name: ðŸ“¤ Report Coverage
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: true
          files: ./sentinel/cobertura.xml
          flags: sentinel
          name: codecov-sentinel
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

  pr-check:
    name: â˜‘ï¸ Combined PR Check
    needs:
      - changes
      - build-proctor
      - build-server
      - build-sentinel
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Summarize job results
        run: |
          declare -A results=(
            [build-proctor]="${{ needs.build-proctor.result }}"
            [build-server]="${{ needs.build-server.result }}"
            [build-sentinel]="${{ needs.build-sentinel.result }}"
          )

          echo "| Job | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"

          failed=0
          for job in "${!results[@]}"; do
            result="${results[$job]:-skipped}"
            echo "| ${job} | ${result} |" >> "$GITHUB_STEP_SUMMARY"
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              failed=1
            fi
          done

          exit $failed
