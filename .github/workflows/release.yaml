name: ğŸ‰ Release and ğŸš€ Deploy

on:
  push:
    branches:
      - release/**
      - ci/add-release-livecycle
  workflow_dispatch:
  workflow_call:
    inputs:
      twilight:
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    name: ğŸ·ï¸ Tag & ğŸ”¨ Build

    outputs:
      version: ${{ steps.update-tag.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Update from Tag
        id: update-tag
        run: |
          set -e

          # hardcoded while in alpha
          CHANNEL=alpha

          if [ "${{ inputs.twilight }}" = "true" ]; then
            CHANNEL=twilight
          fi

          VERSION="$(./scripts/franver.sh $CHANNEL)"

          TAG_NAME="v$VERSION"

          if [ -n "$(git tag -l "$TAG_NAME")" ]; then
              echo "Tag '$TAG_NAME' already exists."
              exit 1
          fi

          git config --local user.name "GitHub Actions [Bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          git tag "$TAG_NAME" HEAD
          git push origin "$TAG_NAME"

          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build-sentinel:
    name: ğŸ—ï¸ Build Sentinel
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix

      - name: âš™ï¸ Set Version
        run: |
          echo "${{ needs.tag.outputs.version }}" > VERSION

      - name: ğŸ—ï¸ Build Sentinel
        run: |
          nix build .#franklyn-sentinel

      - name: ğŸ“¦ Upload Sentinel Artifact
        uses: actions/upload-artifact@v5
        id: artifact-sentinel
        with:
          name: franklyn-sentinel-${{ needs.tag.outputs.version }}
          path: result/bin/franklyn-sentinel-*

  build-server:
    name: ğŸ—ï¸ Build Server
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix

      - name: âš™ï¸ Set Version
        run: |
          echo "${{ needs.tag.outputs.version }}" > VERSION

      - name: ğŸ—ï¸ Build Server
        run: |
          nix build .#franklyn-server

      - name: ğŸ“¦ Upload Server Artifact
        uses: actions/upload-artifact@v5
        id: artifact-server
        with:
          name: franklyn-server-${{ needs.tag.outputs.version }}
          path: result/lib/franklyn-server-*

  build-proctor:
    name: ğŸ—ï¸ Build Proctor
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix

      - name: âš™ï¸ Set Version
        run: |
          echo "${{ needs.tag.outputs.version }}" > VERSION

      - name: ğŸ—ï¸ Build Proctor
        run: |
          cd proctor
          nix develop .#proctor --command fr-proctor-build --base /proctor/
          tar -czf ../franklyn-proctor-${{ needs.tag.outputs.version }}.tar.gz -C dist .

      - name: ğŸ“¦ Upload Proctor Artifact
        uses: actions/upload-artifact@v5
        id: artifact-proctor
        with:
          name: franklyn-proctor-${{ needs.tag.outputs.version }}
          path: franklyn-proctor-*.tar.gz


  release:
    runs-on: ubuntu-latest
    name: ğŸ‰ Release Artifacts

    needs:
      - tag
      - build-sentinel
      - build-server
      - build-proctor

    steps:
      - uses: actions/download-artifact@v4
        name: ğŸ“¦ Download Artifacts
        with:
          pattern: franklyn-*-${{ needs.tag.outputs.version }}*
          path: artifacts/
          merge-multiple: true

      - name: ğŸ“ Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true # lets test this feature
          tag_name: v${{ needs.tag.outputs.version }}

          files: artifacts/*