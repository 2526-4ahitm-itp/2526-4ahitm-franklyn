name: ğŸ‰ Release

on:
  push:
    branches:
      - release/**
      - ci/add-release-livecycle
  workflow_dispatch:  # allows manual triggering for testing

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    name: ğŸ·ï¸ Tag & ğŸ”¨ Build

    outputs:
      tag: ${{ steps.update-tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Update from Tag
        id: update-tag
        run: |
          set -e

          FILE_VER="$(printf "%s" "$(cat VERSION)")"

          git config --local user.name "GitHub Actions [Bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          if git tag | grep -qx "v$FILE_VER"; then
            echo "Tag exists"
            echo "Tag '$FILE_VER' already exists! Aborting ...'"
            exit 1
          fi

          echo "$FILE_VER" > VERSION

          TAG_NAME="v$FILE_VER"

          git tag -a "$TAG_NAME" -m "chore: release $TAG_NAME" HEAD
          git push origin "$TAG_NAME"

          echo "tag=$FILE_VER" >> $GITHUB_OUTPUT
      
      - name: ğŸ—ï¸ Build Sentinel
        run: |
          nix build .#franklyn-sentinel

      - name: ğŸ“¦ Upload Sentinel Artifact
        uses: actions/upload-artifact@v5
        id: artifact-sentinel
        with:
          name: franklyn-sentinel-${{ steps.update-tag.outputs.tag }}
          path: result/bin/franklyn-sentinel-*

      - name: ğŸ—ï¸ Build Server
        run: |
          nix build .#franklyn-server

      - name: ğŸ“¦ Upload Server Artifact
        uses: actions/upload-artifact@v5
        id: artifact-server
        with:
          name: franklyn-server-${{ steps.update-tag.outputs.tag }}
          path: result/lib/franklyn-server-*.jar

  build-sentinel:
    name: ğŸ—ï¸ Build Sentinel
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix

      - name: ğŸ—ï¸ Build Sentinel
        run: |
          nix build .#franklyn-sentinel

      - name: ğŸ“¦ Upload Sentinel Artifact
        uses: actions/upload-artifact@v5
        id: artifact-sentinel
        with:
          name: franklyn-sentinel-${{ needs.tag.outputs.tag }}
          path: result/bin/franklyn-sentinel-*

  build-server:
    name: ğŸ—ï¸ Build Server
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix

      - name: ğŸ—ï¸ Build Server
        run: |
          nix build .#franklyn-sentinel

      - name: ğŸ“¦ Upload Server Artifact
        uses: actions/upload-artifact@v5
        id: artifact-server
        with:
          name: franklyn-server-${{ needs.tag.outputs.tag }}
          path: result/lib/franklyn-server-*


  release:
    runs-on: ubuntu-latest
    name: ğŸ‰ Release Artifacts

    needs:
      - tag
      - build-sentinel
      - build-server

    steps:
      - uses: actions/download-artifact@v4
        name: ğŸ“¦ Download Artifacts
        with:
          path: artifacts/
          merge-multiple: true

      - name: ğŸ“ Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true # lets test this feature
          tag_name: v${{ needs.tag.outputs.tag }}
          files: artifacts/*