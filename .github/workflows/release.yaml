name: ğŸ‰ Release and ğŸš€ Deploy

on:
  push:
    branches:
      - main
      - ci/deploy*
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  tag:
    runs-on: ubuntu-latest
    name: ğŸ·ï¸ Tag & ğŸ”¨ Build

    outputs:
      version: ${{ steps.update-tag.outputs.version }}
      should_release:  ${{ steps.check.outputs.should_release }}
      release_type: ${{ steps.check.outputs.release_type }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check [release] or [twilight]
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message:'$COMMIT_MSG'"

          # hardcoded while in alpha
          RELEASE_TYPE=alpha

          if echo "$COMMIT_MSG" | grep -q "\[release\]"; then
            echo "Release trigger found!"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -q "\[twilight\]"; then
            echo "Twilight release trigger found!"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "release_type=twilight" >> $GITHUB_OUTPUT
          else
            echo "No release trigger found"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "release_type=" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Update from Tag
        id: update-tag
        if: steps.check.outputs.should_release == 'true'
        run: |
          set -e

          VERSION="$(./scripts/franver.sh ${{ steps.check.outputs.release_type }})"

          TAG_NAME="v$VERSION"

          echo -n "$VERSION" > VERSION

          if [ -n "$(git tag -l "$TAG_NAME")" ]; then
              echo "Tag '$TAG_NAME' already exists."
              exit 1
          fi

          git config --local user.name "GitHub Actions [Bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit --allow-empty -m "chore: âœ¨ bump version to '$VERSION' [skip ci]"

          git push origin HEAD

          git tag "$TAG_NAME" HEAD
          git push origin "$TAG_NAME"

          echo "version=$VERSION" >> $GITHUB_OUTPUT


  build-sentinel:
    name: ğŸ—ï¸ Build Sentinel
    runs-on: ubuntu-latest
    if: needs.tag.outputs.should_release == 'true'
    needs: tag
    outputs:
      artifact-id: ${{ steps.artifact-sentinel.outputs.artifact-id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: v${{ needs.tag.outputs.version }}

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          environment: sentinel
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: ğŸ—ï¸ Build Sentinel
        run: |
          nix build .#franklyn-sentinel

          BINARY_NAME=$(basename result/bin/franklyn-sentinel-*)
          echo "ARTIFACT_NAME=$BINARY_NAME" >> "$GITHUB_ENV"

      - name: ğŸ“¦ Upload Sentinel Artifact
        uses: actions/upload-artifact@v5
        id: artifact-sentinel
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: result/bin/franklyn-sentinel-*

  build-server:
    name: ğŸ—ï¸ Build Server
    runs-on: ubuntu-latest
    if: needs.tag.outputs.should_release == 'true'
    needs: tag
    outputs:
      artifact-id: ${{ steps.artifact-server.outputs.artifact-id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: v${{ needs.tag.outputs.version }}

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          environment: server
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: ğŸ—ï¸ Build Server
        run: |
          nix build .#franklyn-server

      - name: ğŸ“¦ Upload Server Artifact
        uses: actions/upload-artifact@v5
        id: artifact-server
        with:
          name: franklyn-server-${{ needs.tag.outputs.version }}
          path: result/lib/franklyn-server-*

  build-proctor:
    name: ğŸ—ï¸ Build Proctor
    runs-on: ubuntu-latest
    if: needs.tag.outputs.should_release == 'true'
    needs: tag
    outputs:
      artifact-id: ${{ steps.artifact-proctor.outputs.artifact-id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: v${{ needs.tag.outputs.version }}

      - name: â„ï¸ Setup Nix
        uses: ./.github/actions/setup-nix
        with:
          environment: proctor
          cachix_auth_token: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: ğŸ—ï¸ Build Proctor
        run: |
          cd proctor
          nix develop .#proctor --command fr-proctor-build --base=/proctor/
          tar -czf ../franklyn-proctor-${{ needs.tag.outputs.version }}.tar.gz -C dist .

      - name: ğŸ“¦ Upload Proctor Artifact
        uses: actions/upload-artifact@v5
        id: artifact-proctor
        with:
          name: franklyn-proctor-${{ needs.tag.outputs.version }}
          path: franklyn-proctor-*.tar.gz
          compression-level: 0

  build-and-publish-docker-images:
    runs-on: ubuntu-latest
    name: ğŸ³ Build & Publish Docker Image
    if: needs.tag.outputs.should_release == 'true'
    needs:
      - tag
      - build-server
      - build-proctor
    permissions:
      packages: write
      attestations: write
      id-token: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}/franklyn
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: v${{ needs.tag.outputs.version }}

      - uses: actions/download-artifact@v4
        name: ğŸ“¦ Download Build Artifacts
        with:
          artifact-ids: |
            ${{ needs.build-server.outputs.artifact-id }},
            ${{ needs.build-proctor.outputs.artifact-id }}
          path: ./
          merge-multiple: true

      - name: ğŸ”‘ Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Build and Push Server
        uses: docker/build-push-action@v6
        id: push-server
        with:
          context: .
          file: ./server/src/main/docker/Dockerfile.part
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server:${{ needs.tag.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server:latest

      - name: ğŸ” Generate Server Artifact Attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-server
          subject-digest: ${{ steps.push-server.outputs.digest }}
          push-to-registry: true

      - name: ğŸ³ Build and Push Proctor
        uses: docker/build-push-action@v6
        id: push-proctor
        with:
          context: .
          file: ./proctor/docker/Dockerfile.part
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-proctor:${{ needs.tag.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-proctor:latest

      - name: ğŸ” Generate Proctor Artifact Attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-proctor
          subject-digest: ${{ steps.push-proctor.outputs.digest }}
          push-to-registry: true


  release:
    runs-on: ubuntu-latest
    name: ğŸ‰ Release Artifacts
    if: needs.tag.outputs.should_release == 'true'

    needs:
      - tag
      - build-sentinel
      - build-server
      - build-proctor

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: v${{ needs.tag.outputs.version }}

      - uses: actions/download-artifact@v4
        name: ğŸ“¦ Download Artifacts
        with:
          artifact-ids: |
            ${{ needs.build-server.outputs.artifact-id }},
            ${{ needs.build-proctor.outputs.artifact-id }},
            ${{ needs.build-sentinel.outputs.artifact-id }}
          path: artifacts/
          merge-multiple: true

      - name: âœï¸ Generate Release Notes (non twilight)
        id: notes_generation
        if: ${{ needs.tag.outputs.release_type != 'twilight' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG="v${{ needs.tag.outputs.version }}"
          REPO="${{ github.repository }}"

          echo "This is a Main Channel Release ($CURRENT_TAG)."

          git fetch --tags --prune

          PREVIOUS_STABLE_TAG=$(git tag -l "v*" | grep -v 'twilight' | sort -V -r | grep -v "^$CURRENT_TAG$" | head -n 1)

          if [ -z "$PREVIOUS_STABLE_TAG" ]; then
            echo "::notice::No previous stable tag found. Notes will be generated from the beginning."
            PREVIOUS_TAG_ARG=""
          else
            echo "Found previous stable tag: $PREVIOUS_STABLE_TAG"
            PREVIOUS_TAG_ARG="-f previous_tag_name=$PREVIOUS_STABLE_TAG"
          fi

          RELEASE_NOTES=$(gh api \
            --method POST \
            /repos/$REPO/releases/generate-notes \
            -f tag_name="$CURRENT_TAG" \
            $PREVIOUS_TAG_ARG \
            --jq '.body')

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“ Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: v${{ needs.tag.outputs.version }}
          body: ${{ steps.notes_generation.outputs.notes }}
          generate_release_notes: ${{ needs.tag.outputs.release_type == 'twilight' }}
          prerelease: ${{ needs.tag.outputs.release_type == 'twilight' }}
          files: artifacts/*