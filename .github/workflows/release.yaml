name: üéâ Release and üöÄ Deploy

on:
  push:
    branches:
      - release/**
      - ci/add-release-livecycle
  workflow_dispatch:
  workflow_call:
    inputs:
      twilight:
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read

jobs:
  tag:
    runs-on: ubuntu-latest
    name: üè∑Ô∏è Tag & üî® Build

    outputs:
      version: ${{ steps.update-tag.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üè∑Ô∏è Update from Tag
        id: update-tag
        run: |
          set -e

          # hardcoded while in alpha
          CHANNEL=alpha

          if [ "${{ inputs.twilight }}" = "true" ]; then
            CHANNEL=twilight
          fi

          VERSION="$(./scripts/franver.sh $CHANNEL)"

          TAG_NAME="v$VERSION"

          if [ -n "$(git tag -l "$TAG_NAME")" ]; then
              echo "Tag '$TAG_NAME' already exists."
              exit 1
          fi

          git config --local user.name "GitHub Actions [Bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          git tag "$TAG_NAME" HEAD
          git push origin "$TAG_NAME"

          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build-sentinel:
    name: üèóÔ∏è Build Sentinel
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚ùÑÔ∏è Setup Nix
        uses: ./.github/actions/setup-nix

      - name: ‚öôÔ∏è Set Version
        run: |
          echo -n "${{ needs.tag.outputs.version }}" > VERSION

      - name: üèóÔ∏è Build Sentinel
        run: |
          nix build .#franklyn-sentinel

          BINARY_NAME=$(basename result/bin/franklyn-sentinel-*)
          echo "ARTIFACT_NAME=$BINARY_NAME" >> "$GITHUB_ENV"

      - name: üì¶ Upload Sentinel Artifact
        uses: actions/upload-artifact@v5
        id: artifact-sentinel
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: result/bin/franklyn-sentinel-*

  build-server:
    name: üèóÔ∏è Build Server
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚ùÑÔ∏è Setup Nix
        uses: ./.github/actions/setup-nix

      - name: ‚öôÔ∏è Set Version
        run: |
          echo -n "${{ needs.tag.outputs.version }}" > VERSION

      - name: üèóÔ∏è Build Server
        run: |
          nix build .#franklyn-server

      - name: üì¶ Upload Server Artifact
        uses: actions/upload-artifact@v5
        id: artifact-server
        with:
          name: franklyn-server-${{ needs.tag.outputs.version }}
          path: result/lib/franklyn-server-*

  build-proctor:
    name: üèóÔ∏è Build Proctor
    runs-on: ubuntu-latest
    needs: tag
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚ùÑÔ∏è Setup Nix
        uses: ./.github/actions/setup-nix

      - name: ‚öôÔ∏è Set Version
        run: |
          echo -n "${{ needs.tag.outputs.version }}" > VERSION

      - name: üèóÔ∏è Build Proctor
        run: |
          cd proctor
          nix develop .#proctor --command fr-proctor-build --base=/proctor/
          tar -czf ../franklyn-proctor-${{ needs.tag.outputs.version }}.tar.gz -C dist .

      - name: üì¶ Upload Proctor Artifact
        uses: actions/upload-artifact@v5
        id: artifact-proctor
        with:
          name: franklyn-proctor-${{ needs.tag.outputs.version }}
          path: franklyn-proctor-*.tar.gz
          compression-level: 0

  release:
    runs-on: ubuntu-latest
    name: üéâ Release Artifacts

    needs:
      - tag
#       - build-sentinel
#       - build-server
#       - build-proctor

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        name: üì¶ Download Artifacts
        with:
          pattern: franklyn-*-${{ needs.tag.outputs.version }}*
          path: artifacts/
          merge-multiple: true

      - name: ‚úèÔ∏è Generate Release Notes (non twilight)
        id: notes_generation
        if: ${{ inputs.twilight != true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG="v${{ needs.tag.outputs.version }}"
          REPO="${{ github.repository }}"

          echo "This is a STABLE release ($CURRENT_TAG)."

          git fetch --tags --prune

          PREVIOUS_STABLE_TAG=$(git tag -l "v*" | grep -v 'twilight' | sort -V -r | grep -v "^$CURRENT_TAG$" | head -n 1)

          if [ -z "$PREVIOUS_STABLE_TAG" ]; then
            echo "::notice::No previous stable tag found. Notes will be generated from the beginning."
            PREVIOUS_TAG_ARG=""
          else
            echo "Found previous stable tag: $PREVIOUS_STABLE_TAG"
            PREVIOUS_TAG_ARG="-f previous_tag_name=$PREVIOUS_STABLE_TAG"
          fi

          RELEASE_NOTES=$(gh api \
            --method POST \
            /repos/$REPO/releases/generate-notes \
            -f tag_name="$CURRENT_TAG" \
            $PREVIOUS_TAG_ARG \
            --jq '.body')

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üìù Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: v${{ needs.tag.outputs.version }}
          body: ${{ steps.notes_generation.outputs.notes }}
          generate_release_notes: ${{ inputs.twilight == true }}
          prerelease: ${{ inputs.twilight == true }}
          files: artifacts/*